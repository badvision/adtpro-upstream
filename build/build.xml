<?xml version="1.0" encoding="UTF-8"?>
<project name="ADTPro" default="jar" basedir="..">
	<property name="versionString" value="0.1.2" />
	<property name="distName" value="ADTPro-${versionString}" />
	<property name="volName" value="ADTPro.${versionString}" />
	<property name="dosVersionString" value="130" />
	<property name="dosDistName" value="ADT${dosVersionString}" />
	<property name="assemblerPath" value="C:/dev/xassm/cc65/bin" />
	<property name="projdir" value="." />
	<property name="builddir" value="${basedir}/build" />
	<property name="acJar" value="AppleCommander-1.3.4b-ac.jar" />
	<taskdef name="appleDump" classname="org.adtpro.utilities.AppleDump" classpath="${projdir}"/>

	<target name="clean">
		<!--
		Clean up everything
		-->
		<delete file="${builddir}/ADTPRO" />
		<delete file="${builddir}/ADTPROETH" />
		<delete file="${builddir}/${distName}.dsk" />
		<delete file="${builddir}/${distName}.jar" />
		<delete file="${builddir}/${distName}.zip" />
		<delete file="${projdir}/org/adtpro/resources/adt.dmp" />
		<delete file="${projdir}/org/adtpro/resources/adtpro.dmp" />
		<delete>
			<fileset dir="${projdir}/client/src" includes="**/*.o"/>
			<fileset dir="${projdir}/client/src" includes="**/*.map"/>
			<fileset dir="${projdir}/client/src" includes="**/*.lst"/>
			<fileset dir="${projdir}/client/src" includes="**/*.lib"/>
		</delete>
	</target>

	<target name="assemble" depends="clean">
		<!--
		Assemble the ADTPro source
		-->
		<exec dir="${projdir}/client/src" executable="${assemblerPath}/ca65">
			<arg line="-l -t c64 ethernet/ethmain.asm" />
		</exec>
		<exec dir="${projdir}/client/src" executable="${assemblerPath}/ca65">
			<arg line="-l -t c64 serial/sermain.asm" />
		</exec>
		<!--
		Assemble the ADT source
		-->
		<exec dir="${projdir}/client/src/dos" executable="${assemblerPath}/ca65">
			<arg line="-l -t c64 adt.asm" />
		</exec>
		<!--
		Assemble the IP65 stack source
		-->
		<apply executable="${assemblerPath}/ca65" dir="${projdir}/client/src/ip65">
			<arg line="-l -t c64" />
			<fileset dir="${projdir}/client/src/ip65" includes="**/*.s"/>
		</apply>
		<!--
		Package the IP65 stack library
		-->
		<exec executable="${assemblerPath}/ar65" dir="${projdir}/client/src/ip65">
			<arg line="a ip65.lib *.o" />
		</exec>
		<!--
		Link the bits
		-->
		<exec dir="${projdir}/client/src" executable="${assemblerPath}/ld65">
			<arg line="-m adtproser.map -C adtpro.cfg -o ADTPRO serial/sermain.o" />
		</exec>
		<exec dir="${projdir}/client/src" executable="${assemblerPath}/ld65">
			<arg line="-m adtproeth.map -C adtpro.cfg -o ADTPROETH ethernet/ethmain.o ip65/ip65.lib" />
		</exec>
		<exec dir="${projdir}/client/src/dos" executable="${assemblerPath}/ld65">
			<arg line="-m adt.map -C adt.cfg -o ADT adt.o" />
		</exec>
		<!--
		Move the object code to the build directory
		-->
		<move file="${projdir}/client/src/ADTPRO" tofile="${builddir}/ADTPRO" />
		<move file="${projdir}/client/src/ADTPROETH" tofile="${builddir}/ADTPROETH" />
		<move file="${projdir}/client/src/dos/ADT" tofile="${builddir}/ADT" />
		<!--
		Make dumpable versions
		-->
		<appleDump infilename="${builddir}/ADTPRO" outfilename="${basedir}/org/adtpro/resources/adtpro.dmp" applename="ADTPRO" startaddrhex="803" numbyteswide="8" />
		<appleDump infilename="${builddir}/ADT" outfilename="${basedir}/org/adtpro/resources/adt.dmp" applename="ADT" startaddrhex="803" numbyteswide="8" />
	</target>

	<target name="builddsk" depends="assemble">
		<!--
		Start a .dsk image containing the release number
		-->
		<copy file="${builddir}/ADTProBase.dsk" tofile="${builddir}/${distName}.dsk" />
		<copy file="${builddir}/ADTBase.dsk" tofile="${builddir}/${dosDistName}.dsk" />
		<!--
		Put the assembled ADTPRO program on the .dsk image a couple of times
		and lock the backup version
		-->
		<exec dir="${builddir}" executable="java" input="${builddir}/ADTPRO">
			<arg line="-jar ${acJar} -p ADTPRO bin 2051 ${distName}.dsk" />
		</exec>
		<exec dir="${builddir}" executable="java" input="${builddir}/ADTPRO">
			<arg line="-jar ${acJar} -p ADTPRO.BACKUP bin 2051 ${distName}.dsk" />
		</exec>
		<!--
		Put the assembled DOS ADT program on the .dsk image
		-->
		<exec dir="${builddir}" executable="java" input="${builddir}/ADT">
			<arg line="-jar ${acJar} -p ADT bin 2051 ${dosDistName}.dsk" />
		</exec>
		<!--
		<exec dir="${builddir}" executable="java" input="${builddir}/ADTPROETH">
			<arg line="-jar ${acJar} -p ADTPROETH bin 2051 ${distName}.dsk" />
		</exec>
		-->
		<!--
		Build a little unit test disk that is 64k (128 blocks) long
		-->
		<!--
		<exec dir="${builddir}" executable="java" input="${builddir}/ADTPROETH">
			<arg line="-jar ${acJar} -d ADTPROETH RAM5.PO" />
		</exec>
		<exec dir="${builddir}" executable="java" input="${builddir}/ADTPROETH">
			<arg line="-jar ${acJar} -p ADTPROETH bin 2051 RAM5.PO" />
		</exec>
		-->
		<!--
		Lock the backup version
		-->
		<exec dir="${builddir}" executable="java">
			<arg line="-jar ${acJar} -k ADTPRO.BACKUP ${distName}.dsk" />
		</exec>
		<!--
		Put a nice volume name on the .dsk image
		-->
		<exec dir="${builddir}" executable="java">
			<arg line="-jar ${acJar} -v ${distName}.dsk ${volName}" />
		</exec>
	</target>

	<target name="jar" depends="builddsk">
		<!-- jar up the source, object and properties files -->
		<jar jarfile="${builddir}/${distName}.jar" manifest="${builddir}/manifest.mf" basedir="${projdir}" includes="org/**/*.class org/**/*.java org/**/*.properties org/**/*.png org/**/*.dmp LICENSE" />
		<!-- zip up the whole sheebang -->
		<zip destfile="${builddir}/${distName}.zip" basedir="${builddir}" includes="${distName}.jar ${distName}.dsk rxtx/rxtx-2.1-7-bins-r2.zip rxtx/fixperm.sh LICENSE README" />
	</target>
</project>
